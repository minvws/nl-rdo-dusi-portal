# 7. Koppelingen

Het DUS-i systeem dient verschillende regelingen voor zowel burgers als instellingen te ondersteunen. De gegevens die
een burger of instelling verschaft dienen gecontroleerd te worden. Dit gebeurt deels handmatig, maar waar mogelijk
zoveel mogelijk geautomatiseerd. Ook is het wenselijk dat zoveel mogelijk van de benodigde gegevens voor een aanvraag
uit officiële systemen worden geïmporteerd. Hiermee wordt het aanvraagproces versimpeld en wordt de kans op misbruik of
oneigenlijk gebruik kleiner.

Voor het controleren en inlezen van gegevens zijn/worden diverse koppelingen gerealiseerd. Omdat niet alle regelingen
dezelfde data behoefte (zullen) hebben worden deze koppelingen via een plug-in mechanisme geïntegreerd.

## 7.1 Plug-in systeem

Het plug-in systeem maakt het mogelijk om buiten de kern van het systeem nieuwe functionaliteit toe te voegen op
de volgende gebieden:

* Authenticatie.
* Validatie.
* Automatisch aan-/invullen.

Er zit een grote overlap tussen beide gebieden omdat ze op basis van gegevens in de aanvraag (of de aanvrager) data
zullen moeten ophalen via de koppeling om deze te vergelijken met wat de gebruiker heeft ingevoerd of automatisch in
te vullen voor bepaalde velden. Plug-ins kunnen daarom ook eventueel meerdere functionaliteiten aanbieden; zowel
authenticatie, validatie en/of automatisch aan-/invullen.

### 7.1.1 Algemeen

Plug-ins registreren zichzelf vanuit een [Laravel provider](https://laravel.com/docs/10.x/providers). Deze kan
onderdeel zijn van een aparte Laravel/composer package, maar kan ook onderdeel zijn van de hoofd repository.

Plug-ins worden per regeling geactiveerd. Dit gebeurt middels configuratie in de database:

![Plug-in configuratie](./images/plug-ins.svg)

Om de hoeveelheid configuratie tot een minimum te beperken kunnen plug-ins inhaken op voorgedefinieerde systeemvelden:

![Systeemvelden](./images/system-fields.svg)

Dit zijn groepen velden zoals NAW-gegevens of bankgegevens met een voorgedefinieerde naam (code) en type. Hierdoor
kan de plug-in broncode rechtstreeks naar deze velden verwijzen en is er de garantie dat het veld bestaat en van
een bepaald type is. Een plug-in kan in zijn definitie bepaalde veldgroepen vereisen om te functioneren. Bij het
activeren van een plug-in voor een bepaalde regeling kan hier op worden gecontroleerd.

Meer informatie over systeem velden is [hier](2.%20Concepten.md) terug te vinden.

### 7.1.2 Authenticatie

Een authenticatie plug-in is verantwoordelijk voor het authenticeren van een gebruiker tegen een extern systeem. Over
het algemeen betekent dit dat de gebruiker naar een ander systeem wordt doorgestuurd om in te loggen en er via een
[OpenID](https://openid.net/) implementatie wordt teruggekoppeld of dit succesvol is geweest en wie de gebruiker
betreft. Dit zal over het algemeen een eenvoudige identifier zijn, zoals bijvoorbeeld een BSN of KVK nummer. Dit kan
weer worden gecombineerd met een plug-in voor automatisch aan-/invullen om bijvoorbeeld de volledige NAW gegevens op te
halen en in te vullen.

### 7.1.3 Validatie

Voor validatie kan een plug-in validatie regels aanbieden. Deze validatie regels kunnen vervolgens worden toegepast
op (compatible) velden. Validatie regels mogen zowel op velden als veld definities worden toegepast. Bij een veld
definitie geldt echter dat de regel alleen toegepast wordt als de plug-in geactiveerd is. Het toepassen van een
validatie regel gebeurt middels de parameters van de veld (definitie).

Validatie regels kunnen zowel in het aanvraagportaal als in de proces stappen van de beoordeling worden toegepast. Dit
kan middels de veld-parameters worden geconfigureerd. In principe dient dus elke plug-in hier rekening mee te houden.
Validatie die plaats vindt tijdens het aanvraagproces zal bij de definitieve inzending van de gebruiker altijd opnieuw
worden gevalideerd.

Validatie plug-ins zijn ook in de mogelijkheid om suggesties te doen indien de ingevoerde waarde heel dicht bij de
verwachte waarde ligt maar de gebruiker wellicht een tikfout o.i.d. heeft gemaakt.

### 7.1.3 Automatisch aan-/invullen

Een automatisch aan-/invullen plug-in kan worden gebruikt om op basis van een identificerend veld, of een combinatie
van velden, automatisch gegevens in te vullen. Denk hierbij adresgegevens op basis van postcode + huisnummer of
bedrijfsgegevens op basis van een KVK nummer.

Deze plug-in maakt gebruik van de standaard veld definities om velden te herkennen om deze enerzijds te kunnen uitlezen
en anderzijds automatisch te kunnen vullen. Een veld kan read-only worden gemarkeerd als de automatisch ingevulde
waarde leidend is. Als de gebruiker de waarde eventueel mag aanpassen kan er gekozen worden om het veld bewerkbaar te
houden. De door de gebruiker aangepaste gegevens worden op dat moment alleen overschreven als de identificerende velden
opnieuw worden aangepast.

Bij het opslaan van de veldwaardes wordt vastgelegd wat de bron is (`source` kolom). Bij automatisch ingevulde waardes
is dit de koppeling, maar als de gebruiker hier wijzigingen in heeft aangebracht is de bron de gebruiker. Op het moment
dat de veldwaardes automatisch zijn ingevuld en de gebruiker deze niet zelf mag aanpassen worden tijdens het opslaan
altijd de meest up-to-date gegevens via de koppeling opgehaald en opgeslagen.

Niet alle regelingen hebben toegang tot dezelfde informatie uit koppelingen. Middels de plug-in configuratie kunnen
de gegevens waartoe een plug-in toegang heeft worden geconfigureerd. De gebruiker kan dan zelf de overige gegevens
aanleveren. Of door middels van veldgroep varianten kunnen de overige velden niet uitgevraagd worden.

#### Synchronisatie

Gegevens die zijn opgehaald via een koppeling kunnen natuurlijk wijzigen. Indien het voor een regeling van belang is
dat de gegevens die zijn opgehaald via de koppeling up-to-date blijven is dit in de configuratie van de plug-in aan te
geven. Een automatisch proces zorgt er voor dat automatisch ingevulde gegevens voor aanvragen die nog in het
behandelproces zitten regelmatig gesynchroniseerd worden met het externe systeem. Per koppeling zal er worden
bekeken of deze een push mechanisme ondersteund waarbij updates automatisch worden aangeboden. Dit heeft echter wel
consequenties voor de netwerk security policy tussen de systemen dus hier moet een goede afweging in worden gemaakt in
samenwerking met het devops team.

## 7.2 Huidige koppelingen

### 7.2.1 SurePay

De [SurePay](https://surepay.nl/) koppeling maakt het mogelijk om bankgegevens te valideren en/of eventueel te
verbeteren. Als invoer dient een IBAN + naam bankrekeninghouder, de SurePay koppeling controleert vervolgens of
het bankrekeningnummer bestaat / valide is en of de ingevoerde bankrekeninghouder ook klopt. Daarbij kan het zijn dat
het systeem in het aanvraagportaal een suggestie doet voor de bankrekeninghouder indien de ingevoerde waarde
net niet klopt.

Deze koppeling is reeds gerealiseerd als onderdeel van het aanvraag- en beoordelingsproces. Op dit moment is dit
echter nog niet als plug-in opgezet. Ook is de client voor het communiceren met SurePay momenteel nog onderdeel van
de DUS-i codebase.

Voor deze koppeling dient de API client nog te worden refactored naar een aparte library in een aparte repository.
Verder dient de integratie in het DUS-i platform middels een validatie plug-in te gebeuren.

### 7.3.2 DigiD

Het aanvraagportaal ondersteunt [DigiD](https://www.digid.nl) via [MAX](https://github.com/minvws/nl-rdo-max)
(Multiple Authentication eXchange). MAX is een binnen iRealisatie ontwikkelde proxy service richting
[TVS](https://www.digitaleoverheid.nl/overzicht-van-alle-onderwerpen/identiteit/toegangsverleningservice/)
(ToegangVerleningService). Het grootste deel van de authenticatie (en de implementatie hiervan) vindt dus buiten
het DUS-i platform plaats. Het DUS-i platform krijgt uiteindelijk een BSN van de ingelogde burger terug die verder
binnen het systeem gebruikt kan worden.

## 7.3 Toekomstige koppelingen

### 7.3.1 Algemene guidelines

Binnen iRealisatie gelden de volgende guidelines met betrekking tot het opzetten van een koppeling met een externe API.

#### Proxy API

Er zijn verschillende redenen om gebruik te maken van een proxy-API in plaats van rechtstreeks met een externe API te
communiceren:

* **Defense in depth**; Indien het om gevoelige gegevens gaat zoals bijvoorbeeld medische gegevens heeft een proxy-API
  als voordeel dat er een extra laag wordt gecreëerd richting deze data. Op het moment dat het systeem wat met
  de proxy-API communiceert op een bepaald moment compromised blijkt te zijn kunnen _authenticatie credentials_ snel
  intern worden ingetrokken. Bij een externe API moet er eerst contact worden gezocht met de beheerder van de
  externe API.
* **Versimpelen interface**; Indien een externe API speciale libraries of andere niet gangbare eisen stelt voor
  communicatie kan een proxy-API uitkomst bieden. De proxy-API maakt het eenvoudig dit deel van het systeem te isoleren
  en onafhankelijk van de rest van het systeem te onderhouden.

Als authenticatie mechanisme voor de proxy-API is de aanbeveling om gebruik te maken van
[mTLS](https://en.wikipedia.org/wiki/Mutual_authentication). Deze best-practice maakt het mogelijk voor devops
om aan beide kanten van het systeem de authenticatie af te dwingen en houdt de code relatief simpel.

#### Library

Bij het bouwen van een abstractie om te communiceren met de externe of proxy-API dient er rekening te worden gehouden
met het kunnen extraheren naar een aparte library repository. Op deze manier kan deze API _client_ worden hergebruikt.
Uiteraard dient er eerst te worden bekeken of een dergelijke abstractie niet al reeds gerealiseerd is en bijvoorbeeld
Open Source beschikbaar is. Ook dient het aanbeveling om eventueel zelf ontwikkelde API-clients voor (semi-)publieke
APIs te Open Sourcen.

### 7.3.2 eHerkenning

[eHerkenning](https://www.eherkenning.nl/nl) is een manier om op een veilige manier ondernemers te laten inloggen,
hierbij zijn verschillende betrouwbaarheidsniveaus mogelijk.

Voor de koppeling met eHerkenning kan er gebruik worden gemaakt van de ondersteuning hiervoor in
[MAX](https://github.com/minvws/nl-rdo-max) (Multiple Authentication eXchange). MAX is een binnen iRealisatie
ontwikkelde proxy service richting
[TVS](https://www.digitaleoverheid.nl/overzicht-van-alle-onderwerpen/identiteit/toegangsverleningservice/)
(ToegangVerleningService). TVS maakt het mogelijk om via configuratie ook eHerkenning te activeren (incl.
het uitlezen van KVK- en vestigingsnummer).

Voor deze koppeling zal deze ondersteuning dienen te worden geactiveerd en er zal bij de authenticatie dienen te worden
meegegeven of een gebruiker tegen DigiD en/of eHerkenning dient te worden geauthenticeerd. Ook zal in de code rekening
moeten worden gehouden met de gebruikersgegevens die eHerkenning teruggeeft na authenticatie. Verder dient er
rekening te worden gehouden met de verschillende betrouwbaarheidsniveaus zodat er eventueel per regeling hier
verschillende eisen aan kunnen worden gesteld.

De eHerkenning koppeling zal binnen de context van DUS-i worden gebruikt als authenticatie mechanisme voor
ondernemers/instellingen zodat ook niet-burger regelingen kunnen worden ondersteund.

### 7.3.3 Handelsregister (KVK)

Het KVK biedt een API die kan worden gebruikt om bedrijfsgegevens op te vragen op basis van een KVK nummer. Aangezien
het hier om publieke informatie gaat kan er direct met deze API worden gecommuniceerd en is er dus geen proxy-API nodig.
Voor toegang tot deze API dient er een API key te worden aangevraagd, er zijn kosten verbonden aan het gebruik van
deze API key.

Voor deze API zijn er diverse Open Source clients [beschikbaar](https://packagist.org/?query=kvk) beschikbaar. Deze
dienen echter eerst te worden geaudit door het security team voor deze kunnen worden ingezet. Binnen het BRBA project
is er echter een eigen (PHP) implementatie ontwikkeld inclusief mocks etc. Deze is
[hier](https://github.com/minvws/nl-covid19-registration-web/blob/main/app/Services/Signup/Kvk/KvkClient.php) terug te
vinden. Voordat deze wordt toegepast voor DUS-i is het aan te raden deze eerst te verhuizen naar een eigen
library repository.

De handelsregister koppeling zal binnen de context van DUS-i worden gebruikt voor het automatisch in-/aanvullen
van bedrijfsgegevens. Op basis van het KVK nummer kunnen onder meer de bedrijfsnaam en het vestigingsadres automatisch
worden ingevuld.

### 7.3.4 Basisregistratie personen (BRP)

Met het BRP wordt gekoppeld via SBVZ (namens een zorg partij) of RVIG (namens een niet-zorg partij). Beide worden
ondersteund door de [RDO BSN (proxy) API](https://github.com/minvws/nl-rdo-bsn-api). Hier dient nog een PHP client
library voor te worden ontwikkeld.

De BRP koppeling zal binnen de context van DUS-i o.a. worden gebruikt voor het automatisch in-/aanvullen van
persoonsgegevens. Op basis van het BSN kunnen bijvoorbeeld de NAW-gegevens voor een persoon worden ingevuld. Deze
koppeling biedt echter toegang tot meer dan alleen NAW-gegevens, zoals bijvoorbeeld kindergegevens. Per regeling kan
deze koppeling daarom in de toekomst verder worden uitgebouwd.

Het BRP biedt de mogelijkheid om een 'afnemersindicatie' te zetten waardoor we push-berichten ontvangen kunnen worden
wanneer iemands gegevens wijzigen.

### 7.3.5 Algemeen GegevensBeheer (AGB)

De AGB koppeling maakt het mogelijk op basis van een zogenaamde AGB-code de gegevens van een zorgaanbieder
op te vragen. Het opvragen van deze gegevens kan via [LRZa](https://www.cibg.nl/lrza) of
[Vektis](https://www.vektis.nl). Voor beiden bestaat er binnen iRealisatie reeds een implementatie of is de
implementatie in de pipeline. Voor het BRBA project is een PHP implementatie voor Vektis momenteel in ontwikkeling.
Deze is [hier](https://github.com/minvws/nl-covid19-registration-web/blob/main/app/Console/Commands/Vektis.php) terug
te vinden. Deze lijkt een goed uitgangspunt voor DUS-i. Wel zal deze nog naar een aparte library dienen te worden
refactored.

De AGB koppeling zal binnen de context van DUS-i worden gebruikt voor een combinatie van het automatisch in/-aanvullen
van zorgaanbieder gegevens en het eventueel valideren van kwalificaties en erkenningen van de zorgaanbieder.
